# Local CI for macOS

Run the same CI checks locally that execute in GitHub Actions, providing fast feedback before pushing.

## Quick Start

```bash
# Run complete CI suite
./scripts/local-ci/run-all.sh

# Run individual jobs
./scripts/local-ci/run-lint.sh     # Linting & formatting
./scripts/local-ci/run-build.sh    # Build matrix
./scripts/local-ci/run-tests.sh    # Test suites
```

## Prerequisites

### Required

1. **macOS 13+** (Ventura or later)
2. **Xcode 16.0+**
   - Install from App Store or [developer.apple.com](https://developer.apple.com/download/)
   - Accept license: `sudo xcodebuild -license accept`
3. **Homebrew** (for tool installation)
   ```bash
   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
   ```

### Optional

4. **Docker Desktop** (for containerized SwiftLint/Python)
   - Download from [docker.com](https://www.docker.com/products/docker-desktop)
   - Only needed if using `SWIFTLINT_MODE=docker`

5. **Python 3.10-3.12** (for script tests)
   ```bash
   brew install python@3.12
   ```

## Configuration

Create `.local-ci-config` in repository root to customize behavior:

```bash
# Tool paths
XCODE_PATH="/Applications/Xcode.app"

# SwiftLint mode: native or docker
SWIFTLINT_MODE="native"

# Test configuration
SKIP_SNAPSHOT_TESTS=false
SKIP_IOS_TESTS=false
COVERAGE_THRESHOLD=0.67

# Performance
PARALLEL_BUILDS=true
MAX_JOBS=4
```

## Usage

### Run Complete Suite

```bash
# Run all checks (lint → build → test)
./scripts/local-ci/run-all.sh

# Stop on first failure
./scripts/local-ci/run-all.sh --fail-fast

# Verbose output
./scripts/local-ci/run-all.sh --verbose
```

### Linting & Formatting

```bash
# Check all linting rules
./scripts/local-ci/run-lint.sh

# Auto-fix issues
./scripts/local-ci/run-lint.sh --fix

# Use Docker for SwiftLint (exact CI parity)
./scripts/local-ci/run-lint.sh --mode docker

# Skip specific checks
./scripts/local-ci/run-lint.sh --skip-json --skip-format
```

**What it runs:**
- SwiftLint (main project, FoundationUI, ComponentTestApp)
- swift-format (Sources/, Tests/)
- JSON validation (MP4RABoxes.json)

### Build Matrix

```bash
# Build everything (SPM + Xcode)
./scripts/local-ci/run-build.sh

# Build only Swift Package Manager targets
./scripts/local-ci/run-build.sh --spm-only

# Build only macOS targets
./scripts/local-ci/run-build.sh --skip-ios

# Release build
./scripts/local-ci/run-build.sh --configuration release
```

**What it builds:**
- **SPM**: ISOInspectorKit, ISOInspectorCLI, ISOInspectorCLIRunner
- **Xcode (macOS)**: ISOInspectorApp, FoundationUI, ComponentTestApp
- **Xcode (iOS)**: FoundationUI, ComponentTestApp

### Test Suites

```bash
# Run all tests
./scripts/local-ci/run-tests.sh

# Run only SPM tests (faster)
./scripts/local-ci/run-tests.sh --spm-only

# Update snapshot baselines
./scripts/local-ci/run-tests.sh --update-snapshots

# Skip iOS tests
./scripts/local-ci/run-tests.sh --skip-ios
```

**What it tests:**
- **SPM**: ISOInspectorKitTests, ISOInspectorCLITests
- **Xcode (macOS)**: ISOInspectorAppTests, FoundationUI tests
- **Xcode (iOS)**: FoundationUI tests
- **Python**: Script tests (scripts/tests/)

## CI Job Mapping

| Local Script | CI Workflow | Description |
|--------------|-------------|-------------|
| `run-lint.sh` | `ci.yml`, `swift-linux.yml`, `swiftlint.yml` | Linting & formatting |
| `run-build.sh` | `ci.yml`, `macos.yml`, `foundationui.yml` | Build matrix |
| `run-tests.sh` | `ci.yml`, `macos.yml`, `foundationui.yml`, `script-tests.yml` | Test suites |
| `run-all.sh` | All workflows | Complete suite |

## Troubleshooting

### "Xcode license needs to be accepted"

```bash
sudo xcodebuild -license accept
```

### "SwiftLint not found"

```bash
# Option 1: Install via Homebrew
brew install swiftlint

# Option 2: Use Docker mode
export SWIFTLINT_MODE=docker
./scripts/local-ci/run-lint.sh
```

### "Tuist version mismatch"

Scripts auto-detect and install the correct Tuist version from CI configuration. If issues persist:

```bash
# Clear Tuist cache
rm -rf ~/.local-ci/tuist

# Re-run build
./scripts/local-ci/run-build.sh
```

### "Xcode workspace not found"

The workspace is generated by Tuist. Run:

```bash
./scripts/local-ci/run-build.sh
```

This will auto-install Tuist and generate the workspace.

### "Test failed but no details shown"

Run with verbose mode:

```bash
./scripts/local-ci/run-tests.sh --verbose
```

Or check individual test logs:

```bash
# SPM tests
swift test --filter ISOInspectorKitTests 2>&1 | tee test-output.log

# Xcode tests
xcodebuild test -workspace ISOInspector.xcworkspace \
  -scheme ISOInspectorAppTests-macOS \
  -destination 'platform=macOS' 2>&1 | tee xcodebuild-test.log
```

### Docker Desktop not running

If using Docker mode for SwiftLint:

1. Start Docker Desktop from Applications
2. Wait for "Docker Desktop is running" indicator
3. Verify: `docker info`

Alternatively, switch to native mode:

```bash
export SWIFTLINT_MODE=native
brew install swiftlint
./scripts/local-ci/run-lint.sh
```

## Performance Tips

1. **Use SPM-only mode for quick iteration**
   ```bash
   ./scripts/local-ci/run-tests.sh --spm-only  # ~2-3 minutes
   ```

2. **Skip iOS builds when not needed**
   ```bash
   ./scripts/local-ci/run-build.sh --skip-ios
   ```

3. **Run lint checks before committing**
   ```bash
   ./scripts/local-ci/run-lint.sh --fix  # Auto-fix + validate
   ```

4. **Parallel builds** (enabled by default)
   - Utilizes all CPU cores
   - Disable with `PARALLEL_BUILDS=false` in config

5. **Build cache reuse**
   - Scripts preserve `.build/` directory
   - Xcode DerivedData is cached automatically

## Integration with Git Workflow

### Pre-commit Checks (Recommended)

```bash
# Before committing
./scripts/local-ci/run-lint.sh --fix
git add .

# Before pushing
./scripts/local-ci/run-all.sh --fail-fast
```

### CI Parity Validation

These scripts aim for ≥95% parity with GitHub Actions. Known differences:

1. **Docker SwiftLint**: Uses same image (`ghcr.io/realm/swiftlint:0.53.0`)
2. **Xcode version**: Must match CI (currently 16.0)
3. **Swift version**: Must match CI (currently 6.0)
4. **Tuist version**: Auto-detected from CI API

If you encounter a local ✅ but CI ❌ (or vice versa):
1. Verify Xcode version: `xcodebuild -version`
2. Try Docker mode: `SWIFTLINT_MODE=docker`
3. Report discrepancy to team

## Advanced Usage

### Run Specific Job Subset

```bash
# Only lint and test (skip build)
./scripts/local-ci/run-all.sh --jobs lint,test
```

### Override Configuration Per Run

```bash
# Use Docker SwiftLint for this run only
SWIFTLINT_MODE=docker ./scripts/local-ci/run-lint.sh

# Skip snapshot tests
SKIP_SNAPSHOT_TESTS=true ./scripts/local-ci/run-tests.sh
```

### Debugging Build Failures

```bash
# Enable verbose output
./scripts/local-ci/run-build.sh --verbose 2>&1 | tee build-debug.log

# Check temp logs
tail -f /tmp/local-ci-output.log
```

## Maintenance

Scripts are located in `scripts/local-ci/`:

```
scripts/local-ci/
├── README.md                # This file
├── run-all.sh              # Orchestrator
├── run-lint.sh             # Linting
├── run-build.sh            # Builds
├── run-tests.sh            # Tests
└── lib/
    ├── common.sh           # Shared utilities
    ├── ci-env.sh           # Environment setup
    └── docker-helpers.sh   # Docker utilities
```

To update scripts when CI changes:
1. Review `.github/workflows/*.yml` for changes
2. Update corresponding `run-*.sh` script
3. Test locally: `./scripts/local-ci/run-all.sh`
4. Update this README if new options added

## Support

- **Documentation**: See `DOCS/AI/github-workflows/04_local_ci_macos/prd.md`
- **Issues**: Report discrepancies between local and CI results
- **Contributing**: Follow existing script structure and add `--help` flags

## License

Same as parent project (ISOInspector).

name: SwiftLint Code Quality

on:
  workflow_dispatch: {}
  pull_request:
    branches:
      - "**"
    paths:
      - 'Sources/**/*.swift'
      - 'Tests/**/*.swift'
      - 'FoundationUI/**/*.swift'
      - 'FoundationUI/.swiftlint.yml'
      - 'Examples/ComponentTestApp/**/*.swift'
      - '.swiftlint.yml'
      - '.github/workflows/swiftlint.yml'
  push:
    branches:
      - main
    paths:
      - 'Sources/**/*.swift'
      - 'Tests/**/*.swift'
      - 'FoundationUI/**/*.swift'
      - 'FoundationUI/.swiftlint.yml'
      - 'Examples/ComponentTestApp/**/*.swift'
      - '.swiftlint.yml'

# Permissions for commenting on PRs
permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swiftlint:
    name: SwiftLint Code Quality Check
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 26.0
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0"

      - name: Show Swift version
        run: swift --version

      - name: Install SwiftLint
        run: |
          set -eo pipefail
          echo "Installing SwiftLint via Homebrew..."

          # Install via Homebrew (simplest and most reliable)
          brew install swiftlint

          # Verify installation
          swiftlint --version

      - name: Run SwiftLint on Main Project (Sources & Tests)
        id: swiftlint-main
        continue-on-error: true
        run: |
          set -eo pipefail

          echo "üîç Running SwiftLint on main project (Sources/, Tests/)..."
          echo "‚ö†Ô∏è  NOTE: Running in INFORMATIONAL mode while existing violations are being addressed"
          swiftlint lint --config .swiftlint.yml --reporter json > /tmp/swiftlint-main.json || true

          # Parse and display results
          if command -v jq &> /dev/null; then
            VIOLATIONS=$(jq 'length' /tmp/swiftlint-main.json)
            ERRORS=$(jq '[.[] | select(.severity == "error")] | length' /tmp/swiftlint-main.json)
            WARNINGS=$(jq '[.[] | select(.severity == "warning")] | length' /tmp/swiftlint-main.json)

            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

            echo "üìä Main Project SwiftLint Results:"
            echo "  Total violations: $VIOLATIONS"
            echo "  Errors: $ERRORS"
            echo "  Warnings: $WARNINGS"

            if [ "$ERRORS" -gt 0 ]; then
              echo "‚ö†Ô∏è  SwiftLint errors found in main project (informational only)"
              echo ""
              echo "Top violations:"
              swiftlint lint --config .swiftlint.yml --reporter xcode | head -50
              echo ""
              echo "üí° These are being tracked for future cleanup - not blocking merge"
            fi
          fi

      - name: Upload SwiftLint Main Project Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-main-report
          path: /tmp/swiftlint-main.json
          retention-days: 30

      - name: Run SwiftLint on FoundationUI
        id: swiftlint-foundationui
        continue-on-error: true
        run: |
          set -eo pipefail
          cd FoundationUI

          echo "üîç Running SwiftLint on FoundationUI..."
          swiftlint --config .swiftlint.yml --reporter json > /tmp/swiftlint-foundationui.json || true

          # Parse and display results
          if command -v jq &> /dev/null; then
            VIOLATIONS=$(jq '.[] | length' /tmp/swiftlint-foundationui.json | jq -s 'add // 0')
            ERRORS=$(jq '[.[] | select(.severity == "error")] | length' /tmp/swiftlint-foundationui.json)
            WARNINGS=$(jq '[.[] | select(.severity == "warning")] | length' /tmp/swiftlint-foundationui.json)

            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

            echo "Total violations: $VIOLATIONS"
            echo "  Errors: $ERRORS"
            echo "  Warnings: $WARNINGS"

            if [ "$ERRORS" -gt 0 ]; then
              echo "‚ùå SwiftLint errors found!"
              swiftlint --config .swiftlint.yml --reporter xcode
              exit 1
            fi
          fi

      - name: Upload SwiftLint FoundationUI Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-foundationui-report
          path: /tmp/swiftlint-foundationui.json
          retention-days: 30

      - name: Run SwiftLint on ComponentTestApp
        id: swiftlint-componenttestapp
        continue-on-error: true
        run: |
          set -eo pipefail
          cd Examples/ComponentTestApp

          echo "üîç Running SwiftLint on ComponentTestApp..."
          swiftlint --reporter json > /tmp/swiftlint-componenttestapp.json || true

          # Parse and display results
          if command -v jq &> /dev/null; then
            VIOLATIONS=$(jq '.[] | length' /tmp/swiftlint-componenttestapp.json | jq -s 'add // 0')
            ERRORS=$(jq '[.[] | select(.severity == "error")] | length' /tmp/swiftlint-componenttestapp.json)
            WARNINGS=$(jq '[.[] | select(.severity == "warning")] | length' /tmp/swiftlint-componenttestapp.json)

            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

            echo "Total violations: $VIOLATIONS"
            echo "  Errors: $ERRORS"
            echo "  Warnings: $WARNINGS"

            if [ "$ERRORS" -gt 0 ]; then
              echo "‚ùå SwiftLint errors found!"
              swiftlint --reporter xcode
              exit 1
            fi
          fi

      - name: Upload SwiftLint ComponentTestApp Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-componenttestapp-report
          path: /tmp/swiftlint-componenttestapp.json
          retention-days: 30

      - name: Comment on PR with SwiftLint Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const mainViolations = parseInt("${{ steps.swiftlint-main.outputs.violations }}" || "0");
            const mainErrors = parseInt("${{ steps.swiftlint-main.outputs.errors }}" || "0");
            const mainWarnings = parseInt("${{ steps.swiftlint-main.outputs.warnings }}" || "0");

            const foundationuiViolations = parseInt("${{ steps.swiftlint-foundationui.outputs.violations }}" || "0");
            const foundationuiErrors = parseInt("${{ steps.swiftlint-foundationui.outputs.errors }}" || "0");
            const foundationuiWarnings = parseInt("${{ steps.swiftlint-foundationui.outputs.warnings }}" || "0");

            const componenttestappViolations = parseInt("${{ steps.swiftlint-componenttestapp.outputs.violations }}" || "0");
            const componenttestappErrors = parseInt("${{ steps.swiftlint-componenttestapp.outputs.errors }}" || "0");
            const componenttestappWarnings = parseInt("${{ steps.swiftlint-componenttestapp.outputs.warnings }}" || "0");

            const totalViolations = mainViolations + foundationuiViolations + componenttestappViolations;
            const totalErrors = mainErrors + foundationuiErrors + componenttestappErrors;
            const totalWarnings = mainWarnings + foundationuiWarnings + componenttestappWarnings;

            let comment = "## üîç SwiftLint Code Quality Report\n\n";

            if (totalViolations === 0) {
              comment += "‚úÖ **No violations found!** Code quality check passed.\n";
            } else {
              comment += `‚ö†Ô∏è **Code Quality Issues Found**\n\n`;
              comment += `### Summary\n\n`;
              comment += `| Component | Errors | Warnings | Total |\n`;
              comment += `|-----------|--------|----------|-------|\n`;
              comment += `| Main Project (Sources & Tests) | ${mainErrors} | ${mainWarnings} | ${mainViolations} |\n`;
              comment += `| FoundationUI | ${foundationuiErrors} | ${foundationuiWarnings} | ${foundationuiViolations} |\n`;
              comment += `| ComponentTestApp | ${componenttestappErrors} | ${componenttestappWarnings} | ${componenttestappViolations} |\n`;
              comment += `| **Total** | **${totalErrors}** | **${totalWarnings}** | **${totalViolations}** |\n\n`;

              if (totalErrors > 0) {
                comment += "‚ùå **Action Required:** Please fix all errors before merging.\n\n";
              }

              comment += "### üì¶ Artifacts\n\n";
              comment += "Detailed SwiftLint reports are available as workflow artifacts:\n";
              comment += "- `swiftlint-main-report` - Main project analysis\n";
              comment += "- `swiftlint-foundationui-report` - FoundationUI analysis\n";
              comment += "- `swiftlint-componenttestapp-report` - ComponentTestApp analysis\n\n";

              comment += "### üîß How to Fix\n\n";
              comment += "Run locally:\n";
              comment += "```bash\n";
              comment += "# Check violations\n";
              comment += "swiftlint lint --strict --config .swiftlint.yml\n\n";
              comment += "# Auto-fix when possible\n";
              comment += "swiftlint --fix --config .swiftlint.yml\n";
              comment += "```\n";
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Quality Gate
        if: always()
        run: |
          MAIN_RESULT="${{ steps.swiftlint-main.outcome }}"
          FOUNDATIONUI_RESULT="${{ steps.swiftlint-foundationui.outcome }}"
          COMPONENTTESTAPP_RESULT="${{ steps.swiftlint-componenttestapp.outcome }}"

          echo "üìä SwiftLint Quality Gate Results:"
          echo "  Main Project: $MAIN_RESULT (informational only - not blocking)"
          echo "  FoundationUI: $FOUNDATIONUI_RESULT"
          echo "  ComponentTestApp: $COMPONENTTESTAPP_RESULT"
          echo ""

          # Only block on FoundationUI and ComponentTestApp failures
          # Main project violations are tracked but not blocking while cleanup is in progress
          if [ "$FOUNDATIONUI_RESULT" = "failure" ] || [ "$COMPONENTTESTAPP_RESULT" = "failure" ]; then
            echo "‚ùå SwiftLint quality gate failed!"
            echo ""
            echo "Next steps:"
            echo "1. Review violations reported above"
            echo "2. Fix code style and complexity issues:"
            echo "   - FoundationUI: cd FoundationUI && swiftlint --config .swiftlint.yml --fix"
            echo "   - ComponentTestApp: cd Examples/ComponentTestApp && swiftlint --fix"
            echo "3. Commit fixed code"
            echo "4. Push changes"
            echo ""
            echo "üí° Tip: Download the SwiftLint report artifacts for detailed analysis"
            exit 1
          else
            echo "‚úÖ SwiftLint quality gate passed!"
            echo ""
            if [ "$MAIN_RESULT" = "failure" ]; then
              echo "‚ö†Ô∏è  NOTE: Main project has violations (see artifacts) but these are"
              echo "    being tracked for future cleanup and are not blocking merges yet."
              echo ""
              echo "üìã Known large files requiring refactoring:"
              echo "   - JSONParseTreeExporter.swift (2127 lines)"
              echo "   - BoxValidator.swift (1738 lines)"
              echo "   - DocumentSessionController.swift (1634 lines)"
            else
              echo "All enforced code meets complexity and style requirements."
            fi
          fi

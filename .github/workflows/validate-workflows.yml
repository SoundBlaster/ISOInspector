name: Validate Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'

jobs:
  validate-yaml-syntax:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate all workflow YAML files
        run: |
          echo "üîç Validating GitHub Actions workflow files..."

          EXIT_CODE=0
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              if python3 -c "import yaml; yaml.safe_load(open('$file'))"; then
                echo "  ‚úÖ Valid YAML syntax"
              else
                echo "  ‚ùå Invalid YAML syntax"
                EXIT_CODE=1
              fi
            fi
          done

          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ All workflow files have valid YAML syntax"
          else
            echo ""
            echo "‚ùå Some workflow files have invalid YAML syntax"
            exit 1
          fi

  validate-with-actionlint:
    name: Validate with actionlint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Run actionlint
        run: |
          echo "üîç Running actionlint on GitHub Actions workflows..."
          ./actionlint -color

  report-validation:
    name: Validation Report
    runs-on: ubuntu-latest
    needs: [validate-yaml-syntax, validate-with-actionlint]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## üìã Workflow Validation Report"
          echo ""

          # Check YAML syntax validation result
          if [ "${{ needs.validate-yaml-syntax.result }}" == "success" ]; then
            echo "‚úÖ YAML syntax validation: **PASSED**"
          else
            echo "‚ùå YAML syntax validation: **FAILED**"
          fi

          # Check actionlint validation result
          if [ "${{ needs.validate-with-actionlint.result }}" == "success" ]; then
            echo "‚úÖ Actionlint validation: **PASSED**"
          else
            echo "‚ùå Actionlint validation: **FAILED**"
          fi

          echo ""

          # Overall result
          if [ "${{ needs.validate-yaml-syntax.result }}" == "success" ] && [ "${{ needs.validate-with-actionlint.result }}" == "success" ]; then
            echo "### ‚úÖ All validations passed successfully"
            exit 0
          else
            echo "### ‚ùå Some validations failed"
            echo ""
            echo "Please review the logs above and fix the issues before merging."
            exit 1
          fi

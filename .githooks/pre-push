#!/bin/bash
# Pre-push hook for FoundationUI
# This hook runs before pushing to ensure code quality
# Install: cp .githooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -eo pipefail

echo "üîç Running pre-push quality checks..."
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Check if we're pushing to main
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
PUSH_REMOTE=$(git config --get branch.${CURRENT_BRANCH}.remote 2>/dev/null || echo "origin")

echo "üìã Pre-push Quality Gate Checklist"
echo "=================================="
echo ""

# 1. Check for SwiftLint violations (if installed)
echo "1Ô∏è‚É£  Checking code quality with SwiftLint..."
if command -v swiftlint &> /dev/null; then
    if cd FoundationUI && swiftlint --config .swiftlint.yml --quiet; then
        echo -e "${GREEN}‚úÖ SwiftLint check passed${NC}"
    else
        echo -e "${RED}‚ùå SwiftLint violations found${NC}"
        echo "   Run: cd FoundationUI && swiftlint --config .swiftlint.yml --fix"
        FAILED=$((FAILED + 1))
    fi
    cd - > /dev/null
else
    echo -e "${YELLOW}‚ö†Ô∏è  SwiftLint not installed (optional)${NC}"
    echo "   Install: brew install swiftlint"
fi
echo ""

# 2. Run unit tests
echo "2Ô∏è‚É£  Running unit tests..."
if cd FoundationUI && swift test --quiet; then
    echo -e "${GREEN}‚úÖ All tests passed${NC}"
else
    echo -e "${RED}‚ùå Tests failed${NC}"
    FAILED=$((FAILED + 1))
fi
cd - > /dev/null
echo ""

# 3. Check build succeeds
echo "3Ô∏è‚É£  Verifying build..."
if cd FoundationUI && swift build --quiet; then
    echo -e "${GREEN}‚úÖ Build successful${NC}"
else
    echo -e "${RED}‚ùå Build failed${NC}"
    FAILED=$((FAILED + 1))
fi
cd - > /dev/null
echo ""

# 4. Check for large files in commits being pushed
echo "4Ô∏è‚É£  Checking for large files in commits being pushed..."
# Check commits between remote main and current branch
MERGE_BASE=$(git merge-base origin/main HEAD 2>/dev/null || echo "HEAD")
LARGE_FILES=$(git diff $MERGE_BASE...HEAD --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ]; then
        # Use wc -c for cross-platform compatibility (works on macOS and Linux)
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 10485760 ]; then  # 10MB
            echo "$file ($((SIZE/1048576))MB)"
        fi
    fi
done)

if [ -z "$LARGE_FILES" ]; then
    echo -e "${GREEN}‚úÖ No large files detected${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Large files detected:${NC}"
    echo "$LARGE_FILES"
    echo "   Consider using Git LFS for binary files"
fi
echo ""

# 5. Check for secrets in commits being pushed
echo "5Ô∏è‚É£  Scanning for secrets in commits being pushed..."
SECRETS_FOUND=0
MERGE_BASE=$(git merge-base origin/main HEAD 2>/dev/null || echo "HEAD")
for commit in $(git rev-list $MERGE_BASE...HEAD); do
    if git show "$commit" | grep -qE 'API[_-]?KEY|PASSWORD|SECRET|TOKEN|PRIVATE[_-]?KEY'; then
        echo -e "${RED}‚ö†Ô∏è  Potential secret in commit: $commit${NC}"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
done

if [ "$SECRETS_FOUND" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No secrets detected${NC}"
else
    echo -e "${RED}‚ùå Potential secrets found - do not push!${NC}"
    FAILED=$((FAILED + 1))
fi
echo ""

# Summary
echo "=================================="
if [ "$FAILED" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"
    echo "Proceeding with push to $PUSH_REMOTE..."
    exit 0
else
    echo -e "${RED}‚ùå Pre-push checks failed ($FAILED issues)${NC}"
    echo ""
    echo "Next steps:"
    echo "1. Fix the issues listed above"
    echo "2. Stage your changes: git add ."
    echo "3. Try pushing again: git push"
    echo ""
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
fi

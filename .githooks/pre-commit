#!/bin/bash
# Pre-commit hook for FoundationUI
# This hook runs before committing to ensure code quality and style
# Install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -eo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "üîç Running pre-commit quality checks..."
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Determine how to run SwiftLint (local binary preferred, fallback to Docker)
SWIFTLINT_MODE="none"
if command -v swiftlint &> /dev/null; then
    SWIFTLINT_MODE="local"
elif command -v docker &> /dev/null; then
    SWIFTLINT_MODE="docker"
fi

run_swiftlint() {
    local target_dir="$1"
    shift

    if [ "$SWIFTLINT_MODE" = "local" ]; then
        (cd "$target_dir" && swiftlint "$@")
    elif [ "$SWIFTLINT_MODE" = "docker" ]; then
        docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$REPO_ROOT:/work" \
            -w "/work/$target_dir" \
            ghcr.io/realm/swiftlint:0.53.0 \
            swiftlint "$@"
    else
        return 1
    fi
}

lint_staged_files() {
    local label="$1"
    local target_dir="$2"
    local config_path="$3"
    shift 3
    local files=("$@")

    if [ ${#files[@]} -eq 0 ]; then
        return 0
    fi

    local config_args=()
    if [ -n "$config_path" ]; then
        config_args=(--config "$config_path")
    fi

    echo "   ‚Ä¢ $label: ${#files[@]} staged file(s)"

    local lint_failed=0
    for file in "${files[@]}"; do
        if ! run_swiftlint "$target_dir" lint --strict --quiet "${config_args[@]}" --path "$file"; then
            echo "     ‚Ü≥ ‚ùå $file"
            lint_failed=1
        fi
    done

    if [ $lint_failed -eq 0 ]; then
        echo "     ‚Ü≥ ‚úÖ Passed"
        return 0
    fi

    return 1
}

# Check for SwiftLint violations on staged files
if [ "$SWIFTLINT_MODE" != "none" ]; then
    echo "1Ô∏è‚É£  Checking code style with SwiftLint (${SWIFTLINT_MODE})..."

    STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep '\.swift$' || true)

    if [ -n "$STAGED_SWIFT_FILES" ]; then
        readarray -t STAGED_SWIFT_FILES_ARRAY <<< "$STAGED_SWIFT_FILES"

        MAIN_FILES=()
        FOUNDATIONUI_FILES=()
        COMPONENT_FILES=()

        for file in "${STAGED_SWIFT_FILES_ARRAY[@]}"; do
            case "$file" in
                FoundationUI/*)
                    FOUNDATIONUI_FILES+=("${file#FoundationUI/}")
                    ;;
                Examples/ComponentTestApp/*)
                    COMPONENT_FILES+=("${file#Examples/ComponentTestApp/}")
                    ;;
                *)
                    MAIN_FILES+=("$file")
                    ;;
            esac
        done

        GROUP_FAILED=0
        lint_staged_files "Main project" "." ".swiftlint.yml" "${MAIN_FILES[@]}" || GROUP_FAILED=1
        lint_staged_files "FoundationUI" "FoundationUI" ".swiftlint.yml" "${FOUNDATIONUI_FILES[@]}" || GROUP_FAILED=1
        lint_staged_files "ComponentTestApp" "Examples/ComponentTestApp" "" "${COMPONENT_FILES[@]}" || GROUP_FAILED=1

        if [ $GROUP_FAILED -ne 0 ]; then
            echo "‚ùå SwiftLint violations detected in staged files"
            echo "   Run 'swiftlint lint --strict' (or cd into the scoped directory) to view details."
            FAILED=$((FAILED + 1))
        else
            echo "‚úÖ All staged Swift files pass SwiftLint"
        fi
    else
        echo "‚ö†Ô∏è  No Swift files staged"
    fi
    echo ""
else
    echo "‚ö†Ô∏è  SwiftLint not available (install swiftlint or docker)"
    echo ""
fi

# Check for trailing whitespace
echo "2Ô∏è‚É£  Checking for trailing whitespace..."
if git diff --cached 2>/dev/null | grep -q '^[+].*[[:space:]]$'; then
    echo "‚ùå Trailing whitespace found"
    FAILED=$((FAILED + 1))
else
    echo "‚úÖ No trailing whitespace"
fi
echo ""

# Summary
echo "=================================="
if [ "$FAILED" -eq 0 ]; then
    echo "‚úÖ All pre-commit checks passed!"
    exit 0
else
    echo "‚ùå Pre-commit checks failed ($FAILED issues)"
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

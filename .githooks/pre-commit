#!/bin/bash
# Pre-commit hook for FoundationUI
# This hook runs before committing to ensure code quality and style
# Install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -eo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "üîç Running pre-commit quality checks..."
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Determine how to run SwiftLint (local binary preferred, fallback to Docker)
SWIFTLINT_MODE="none"
if command -v swiftlint &> /dev/null; then
    SWIFTLINT_MODE="local"
elif command -v docker &> /dev/null; then
    SWIFTLINT_MODE="docker"
fi

run_swiftlint() {
    local target_dir="$1"
    shift

    if [ "$SWIFTLINT_MODE" = "local" ]; then
        (cd "$target_dir" && swiftlint "$@")
    elif [ "$SWIFTLINT_MODE" = "docker" ]; then
        docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$REPO_ROOT:/work" \
            -w "/work/$target_dir" \
            ghcr.io/realm/swiftlint:0.53.0 \
            swiftlint "$@"
    else
        return 1
    fi
}

# Check for SwiftLint violations
if [ "$SWIFTLINT_MODE" != "none" ]; then
    echo "1Ô∏è‚É£  Checking code style with SwiftLint (${SWIFTLINT_MODE})..."

    STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep '\.swift$' || true)

    if [ -n "$STAGED_SWIFT_FILES" ]; then
        # Check FoundationUI files
        FOUNDATIONUI_FILES=$(echo "$STAGED_SWIFT_FILES" | grep '^FoundationUI/' || true)
        if [ -n "$FOUNDATIONUI_FILES" ]; then
            if run_swiftlint "FoundationUI" --config .swiftlint.yml --quiet; then
                echo "‚úÖ FoundationUI: Code style check passed"
            else
                echo "‚ùå FoundationUI: SwiftLint violations found"
                echo "   Run: cd FoundationUI && swiftlint --config .swiftlint.yml --fix"
                FAILED=$((FAILED + 1))
            fi
        fi

        # Check ComponentTestApp files
        COMPONENTTESTAPP_FILES=$(echo "$STAGED_SWIFT_FILES" | grep '^Examples/ComponentTestApp/' || true)
        if [ -n "$COMPONENTTESTAPP_FILES" ]; then
            if run_swiftlint "Examples/ComponentTestApp" --quiet; then
                echo "‚úÖ ComponentTestApp: Code style check passed"
            else
                echo "‚ùå ComponentTestApp: SwiftLint violations found"
                echo "   Run: cd Examples/ComponentTestApp && swiftlint --fix"
                FAILED=$((FAILED + 1))
            fi
        fi
    else
        echo "‚ö†Ô∏è  No Swift files staged"
    fi
    echo ""
else
    echo "‚ö†Ô∏è  SwiftLint not available (install swiftlint or docker)"
    echo ""
fi

# Check for trailing whitespace
echo "2Ô∏è‚É£  Checking for trailing whitespace..."
if git diff --cached 2>/dev/null | grep -q '^[+].*[[:space:]]$'; then
    echo "‚ùå Trailing whitespace found"
    FAILED=$((FAILED + 1))
else
    echo "‚úÖ No trailing whitespace"
fi
echo ""

# Summary
echo "=================================="
if [ "$FAILED" -eq 0 ]; then
    echo "‚úÖ All pre-commit checks passed!"
    exit 0
else
    echo "‚ùå Pre-commit checks failed ($FAILED issues)"
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

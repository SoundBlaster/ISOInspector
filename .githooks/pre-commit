#!/bin/bash
# Pre-commit hook for FoundationUI
# This hook runs before committing to ensure code quality and style
# Install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -eo pipefail

echo "üîç Running pre-commit quality checks..."
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Check for SwiftLint violations
if command -v swiftlint &> /dev/null; then
    echo "1Ô∏è‚É£  Checking code style with SwiftLint..."

    STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep '\.swift$' || true)

    if [ -n "$STAGED_SWIFT_FILES" ]; then
        # Check FoundationUI files
        FOUNDATIONUI_FILES=$(echo "$STAGED_SWIFT_FILES" | grep '^FoundationUI/' || true)
        if [ -n "$FOUNDATIONUI_FILES" ]; then
            if cd FoundationUI && swiftlint --config .swiftlint.yml --quiet; then
                echo "‚úÖ FoundationUI: Code style check passed"
            else
                echo "‚ùå FoundationUI: SwiftLint violations found"
                echo "   Run: cd FoundationUI && swiftlint --config .swiftlint.yml --fix"
                FAILED=$((FAILED + 1))
            fi
            cd - > /dev/null
        fi

        # Check ComponentTestApp files
        COMPONENTTESTAPP_FILES=$(echo "$STAGED_SWIFT_FILES" | grep '^Examples/ComponentTestApp/' || true)
        if [ -n "$COMPONENTTESTAPP_FILES" ]; then
            if cd Examples/ComponentTestApp && swiftlint --quiet; then
                echo "‚úÖ ComponentTestApp: Code style check passed"
            else
                echo "‚ùå ComponentTestApp: SwiftLint violations found"
                echo "   Run: cd Examples/ComponentTestApp && swiftlint --fix"
                FAILED=$((FAILED + 1))
            fi
            cd - > /dev/null
        fi
    else
        echo "‚ö†Ô∏è  No Swift files staged"
    fi
    echo ""
else
    echo "‚ö†Ô∏è  SwiftLint not installed"
    echo "   Install: brew install swiftlint"
    echo ""
fi

# Check for trailing whitespace
echo "2Ô∏è‚É£  Checking for trailing whitespace..."
if git diff --cached 2>/dev/null | grep -q '^[+].*[[:space:]]$'; then
    echo "‚ùå Trailing whitespace found"
    FAILED=$((FAILED + 1))
else
    echo "‚úÖ No trailing whitespace"
fi
echo ""

# Summary
echo "=================================="
if [ "$FAILED" -eq 0 ]; then
    echo "‚úÖ All pre-commit checks passed!"
    exit 0
else
    echo "‚ùå Pre-commit checks failed ($FAILED issues)"
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi
